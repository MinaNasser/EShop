<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Dashboard | Pointai</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="styles.css">
    <style>
        .cart-icon {
            position: relative;
            font-size: 24px;
            cursor: pointer;
        }

        .cart-count {
            position: absolute;
            top: -5px;
            right: -10px;
            background: red;
            color: white;
            font-size: 14px;
            border-radius: 50%;
            padding: 2px 6px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-light bg-light px-4">
        <h3>Client Dashboard</h3>
        <div>
            <span class="cart-icon" onclick="viewCart()">
                üõí <span id="cart-count" class="cart-count">0</span>
            </span>
            <button class="btn btn-danger" onclick="logout()">Logout</button>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="text-center text-primary">Products</h2>
        <p id="loading-text" class="text-center text-muted">Loading products...</p>
        <div id="products-list" class="row">
            <!-- ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≥ÿ™ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™Ÿáÿß ŸáŸÜÿß ÿØŸäŸÜÿßŸÖŸäŸÉŸäŸãÿß -->
        </div>
    </div>

    <script>

        document.addEventListener("DOMContentLoaded", function () {
            checkTokenExpiry();
            updateCartCount();
            loadProducts();
        });

        function checkTokenExpiry() {
            const token = localStorage.getItem("token");
            const expiryTime = localStorage.getItem("token_expiry");

            if (!token || !expiryTime) {
                alert("Session expired, please login again.");
                logout();
                return;
            }

            const currentTime = Date.now();
            if (currentTime >= expiryTime) {
                alert("Session expired, please login again.");
                logout();
            }
        }

        function logout() {
            localStorage.removeItem("token");
            localStorage.removeItem("token_expiry");
            window.location.href = "index.html";
        }

        function updateCartCount() {
            const token = localStorage.getItem("token");
            if (!token) {
                console.error("No token found. User might not be logged in.");
                return;
            }

            fetch("http://localhost:5044/api/cart/count", {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert("Session expired, please login again.");
                            logout();
                        }
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.count !== undefined) {
                        document.getElementById("cart-count").innerText = data.count;
                    } else {
                        console.error("Invalid response format:", data);
                    }
                })
                .catch(error => console.error("Error fetching cart count:", error));
        }

        function loadProducts() {
            fetch("http://localhost:5044/api/Product/products")
                .then(response => response.json())
                .then(data => {
                    console.log("Product API Response:", data);
                    document.getElementById("loading-text").style.display = "none";

                    let productsList = document.getElementById("products-list");

                    if (!Array.isArray(data.data)) {
                        console.error("Expected an array but got:", data);
                        productsList.innerHTML = `<p class='text-center text-muted'>Error loading products.</p>`;
                        return;
                    }

                    if (data.data.length === 0) {
                        productsList.innerHTML = `<p class='text-center text-muted'>No products available.</p>`;
                        return;
                    }

                    data.data.forEach(product => {
                        let imageUrl = product.imageUrl ? product.imageUrl : "placeholder.jpg";
                        let productCard = document.createElement("div");
                        productCard.className = "col-md-4 mb-4";
                        productCard.innerHTML = `
                        <div class="card shadow-sm">
                            <img src="${imageUrl}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text text-muted">${product.description}</p>
                                <p class="card-text"><strong>Price:</strong> $${product.price}</p>
                                <button class="btn btn-primary" onclick="addToCart(${product.id})">Add to Cart</button>
                            </div>
                        </div>
                    `;
                        productsList.appendChild(productCard);
                    });
                })
                .catch(error => {
                    console.error("Error fetching products:", error);
                    document.getElementById("loading-text").innerText = "Failed to load products. Please try again.";
                });
        }

        function addToCart(productId) {
            const token = localStorage.getItem("token");

            if (!token) {
                alert("Session expired. Please login again.");
                logout();
                return;
            }

            fetch(`http://localhost:5044/api/cart/add/${productId}`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${token}`,
                    "Content-Type": "application/json"
                }
            })
                .then(response => {
                    if (!response.ok) {
                        if (response.status === 401) {
                            alert("Session expired. Please login again.");
                            logout();
                        }
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json().catch(() => ({})); // ÿ™ÿ¨ŸÜÿ® ÿÆÿ∑ÿ£ JSON ŸÅÿßÿ±ÿ∫
                })
                .then(data => {
                    alert("Product added to cart successfully!");
                    updateCartCount();
                })
                .catch(error => console.error("Error adding to cart:", error));
        }
        function viewCart() {
            window.location.href = "./cart.html"; // ‚úÖ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ŸÑÿ©
        }

    </script>


</body>

</html>